FROM node:20-alpine AS build
WORKDIR /app

COPY package.json package-lock.json ./
RUN npm ci

ARG VITE_CHAIN_ID
ARG VITE_HTTP_ORIGIN
ARG VITE_PRIVY_APP_ID
ARG VITE_WORLD_CONTRACT_ADDRESS
ARG VITE_PONDER_HTTP_URL
ARG VITE_PONDER_WS_URL
ARG VITE_GAME_SERVER_URL
ARG VITE_WS_ENDPOINT

# Vite only exposes env vars to the client bundle at build time (VITE_*).
ENV VITE_CHAIN_ID=$VITE_CHAIN_ID
ENV VITE_HTTP_ORIGIN=$VITE_HTTP_ORIGIN
ENV VITE_PRIVY_APP_ID=$VITE_PRIVY_APP_ID
ENV VITE_WORLD_CONTRACT_ADDRESS=$VITE_WORLD_CONTRACT_ADDRESS
ENV VITE_PONDER_HTTP_URL=$VITE_PONDER_HTTP_URL
ENV VITE_PONDER_WS_URL=$VITE_PONDER_WS_URL
ENV VITE_GAME_SERVER_URL=$VITE_GAME_SERVER_URL
ENV VITE_WS_ENDPOINT=$VITE_WS_ENDPOINT

COPY . .
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV PORT=3000

# Simple, reliable static hosting with SPA fallback (-s)
RUN npm install -g serve@14.2.4

COPY --from=build /app/dist ./dist

EXPOSE 3000
CMD ["sh", "-c", "serve -s dist -l ${PORT:-3000}"]


